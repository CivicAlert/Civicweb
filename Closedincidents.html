<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Alert - ClosedIncidents</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    display: flex;
}
.nav ul {
    list-style-type: none;
    padding: 0;
    width: 100%;
}

.nav li {
    width: 100%;
    margin-bottom: 10px;
}
.sidebar {
    width: 250px !important;
    background: #f4f4f4 !important;
    padding: 20px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
}

.logo img {
    width: 100px !important;
}

.profile img {
    width: 80px !important;
    border-radius: 50% !important;
}

.nav button {
    width: 100% !important;
    padding: 10px !important;
    margin: 5px 0 !important;
    background: #fff !important;
    border: 1px solid #ddd !important;
    cursor: pointer !important;
}

.logout {
    margin-top: auto !important;
    padding: 10px 20px !important;
    background: #d9534f !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
}

.report-header-row {
            background-color: #f0f0f0;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .report-header-row p {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
            text-align: center;
        }

        /* Report Cards */
        .report-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #fff;
            position: relative;
        }

        .report-card h4 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }

        .report-card p {
            margin: 0;
            font-size: 14px;
        }

        .report-card .report-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        /* Table-style layout for the reports */
        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th, .reports-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .reports-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* Modal Styling */
        .modal .modal-body {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal img {
            max-width: 100%;
            height: auto;
            margin-right: 20px;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <img src="Images/logo.jpg" alt="Civic Alert Logo">
        </div>
        <div class="profile">
            <img src="Images/profileicon.jpeg" alt="Profile Picture">
            <p>Municipality</p>
        </div>
        <nav class="nav">
            <ul>
                <li><button onclick="window.location.href = '/dashboard.html'"><img src="Images/dashboard.png" height="20" width="20">Dashboard</button></li>
                <li><button onclick="window.location.href = '/OpenReports.html'"><img src="Images/opened.jpeg" height="20" width="20">Open Reports</button></li>
                <li><button onclick="window.location.href = '/Unassigned.html'"><img src="Images/unassigneddd.png" height="20" width="20">Unassigned Reports</button></li>
                <li><button onclick="window.location.href = '/assignedincidents.html'"><img src="Images/asigned.png" height="20" width="20">Assigned Reports</button></li>
                <li><button onclick="window.location.href = '/Closedincidents.html'"><img src="CSS/Closed .png" height="20" width="20">Closed Incidents</button></li>
                <li><button onclick="window.location.href = '/Incidents.html'"><img src="Images/reports.jpeg" height="20" width="20">Reports</button></li>
            </ul>
        </nav>
        <a href="Login.html">
            <button class="logout">Log out</button>
        </a>
    </aside>
            <main class="col-md-10 main-content">
                <header class="mb-4">
                    <h2>Reports</h2>
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>UserID</th>
                                <th>Category</th>
                                <th>Date</th>
                                <th>Reference Number</th>
                                <th>Location</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Report rows will be dynamically added here -->
                        </tbody>
                    </table>
                </header>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Report Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <img id="modalReportImage" src="" alt="Report Image">
                    </div>
                    <div id="modalReportDetails">
                        <!-- Details will be populated here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyDXpT6oe6SNKk0kHJLePqlMmLnd1kRSWT8",
            authDomain: "civicalertoriginal.firebaseapp.com",
            databaseURL: "https://civicalertoriginal-default-rtdb.firebaseio.com",
            projectId: "civicalertoriginal",
            storageBucket: "civicalertoriginal.appspot.com",
            messagingSenderId: "858192785417",
            appId: "1:858192785417:web:424b1bec909661ab29c8d8",
            measurementId: "G-KJ0C1TE4JS"
        };
    
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);
    
        function fetchSubmittedReports() {
            const reportsRef = ref(database, 'Make Report Instance');
            
            console.log('Attempting to fetch reports...');  // Debug log
            
            get(reportsRef).then(snapshot => {
                if (snapshot.exists()) {
                    console.log('Data retrieved successfully:', snapshot.val());  // Debug log
                    
                    const reports = snapshot.val();
                    const reportTableBody = document.getElementById('reportTableBody');
                    reportTableBody.innerHTML = '';  // Clear previous data
    
                    Object.keys(reports).forEach(reportId => {
                        const report = reports[reportId];

                        if(report.status === "Resolved"){
                        const row = document.createElement('tr');
    
                        row.innerHTML = `
                            <td>${report.userUID}</td>
                            <td>${report.incidentType}</td>
                            <td>${report.dateTime}</td>
                            <td>${report.refNumber}</td>
                            <td>${report.location}</td>
                            <td>${report.description}</td>
                            <td>${report.status}</td>
                            <td><button class="btn btn-primary" data-report-id="${report.refNumber}">View Image</button></td>
                        `;
    
                        reportTableBody.appendChild(row);
                        }
                    });
    
                    document.querySelectorAll('button[data-report-id]').forEach(button => {
                        button.addEventListener('click', function() {
                            const reportId = this.getAttribute('data-report-id');
                            const report = reports[refNumber]
                           const imageRef = storageRef(storage, `report-images/${report.refNumber}.jpeg`);
    
                            getDownloadURL(imageRef).then(url => {

                        // Display the image and details in the modal
                                    document.getElementById('modalReportImage').src = url;
                                   document.getElementById('modalReportDetails').innerHTML = `
                                    <p><strong>Reference Number:</strong> ${report.refNumber}</p>
                                    <p><strong>User ID:</strong> ${report.userId}</p>
                                   <p><strong>Description:</strong> ${report.description}</p>
                                `;
                                $('#reportModal').modal('show');
                            }).catch(error => {
                                console.error("Error fetching image:", error);  // Debug log
                                alert("Image could not be retrieved.");
                            });
                        });
                    });
                } else {
                    console.error("No data found in the database.");  // Debug log
                    alert("No data available for the reports.");
                }
            }).catch(error => {
                console.error("Error fetching reports:", error);  // Debug log
                alert("Error fetching reports. Please try again.");
            });
        }
    
        fetchSubmittedReports();
    </script>
    
</body>
</html>