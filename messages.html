<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Civic Alert</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .logo img, .profile img {
            width: 100%;
            height: auto;
        }
        
        .nav ul {
            list-style-type: none;
            padding: 0;
        }

        .nav ul li {
            margin-bottom: 10px;
        }

        .nav ul li button {
            background-color: #90ee90;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .nav ul li button img {
            margin-right: 10px;
        }

        .nav ul li button:hover {
            background-color: #76c76b;
        }

        .profile p {
            text-align: center;
        }

        .report-header-row {
            background-color: #f0f0f0;
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .report-header-row p {
            font-size: 16px;
            font-weight: bold;
            margin: 0;
            text-align: center;
        }

        /* Report Cards */
        .report-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 15px;
            background-color: #fff;
            position: relative;
        }

        .report-card h4 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }

        .report-card p {
            margin: 0;
            font-size: 14px;
        }

        .report-card .report-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        /* Table-style layout for the reports */
        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th, .reports-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .reports-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* Modal Styling */
        .modal .modal-body {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal img {
            max-width: 100%;
            height: auto;
            margin-right: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-md-2 bg-light p-3 sidebar">
                <div class="text-center mb-4 logo">
                    <img src="logo.jpg" class="img-fluid" alt="Civic Alert Logo">
                </div>
                <div class="text-center mb-4 profile">
                    <img src="profileicon.jpeg" class="img-fluid rounded-circle" alt="Profile Picture" style="width: 100px; height: 100px;">
                    <p class="mt-2">Municipality</p>
                </div>
                <nav class="nav">
                    <ul>
                        <li><button ><img src="reports.jpeg" height="20" width="20">Reports</button></li>
                        <li><button><img src="dashboard.png" height="20" width="20">Dashboard</button></li>
                        <li><button><img src="closed.jpeg" height="20" width="20">Closed Reports</button></li>
                        <li><button><img src="opened.jpeg" height="20" width="20">Open Reports</button></li>
                        <li><button><img src="unassigned.jpeg" height="20" width="20">Unassigned Reports</button></li>
                        <li><button><img src="asigned.png" height="20" width="20">Assigned Reports</button></li>
                    </ul>
                </nav>
            </aside>
            <main class="col-md-10 main-content">
                <header class="mb-4">
                    <h2>Reports</h2>
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>UserID</th>
                                <th>Category</th>
                                <th>Date</th>
                                <th>Reference Number</th>
                                <th>Location</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- Report rows will be dynamically added here -->
                        </tbody>
                    </table>
                </header>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Report Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <img id="modalReportImage" src="" alt="Report Image">
                    </div>
                    <div id="modalReportDetails">
                        <!-- Details will be populated here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
        import {getMessaging , onMessage}  from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";

    
        const firebaseConfig = {
            apiKey: "AIzaSyDXpT6oe6SNKk0kHJLePqlMmLnd1kRSWT8",
            authDomain: "civicalertoriginal.firebaseapp.com",
            databaseURL: "https://civicalertoriginal-default-rtdb.firebaseio.com",
            projectId: "civicalertoriginal",
            storageBucket: "civicalertoriginal.appspot.com",
            messagingSenderId: "858192785417",
            appId: "1:858192785417:web:424b1bec909661ab29c8d8",
            measurementId: "G-KJ0C1TE4JS"
        };
    
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        const functions = require('firebase-functions');
const admin = require('firebase-admin');
const nodemailer = require('nodemailer');

// Initialize Firebase Admin
admin.initializeApp();

// Configure your email transport using Nodemailer
const transporter = nodemailer.createTransport({
    service: 'gmail', // You can use another email provider (e.g., Outlook, Yahoo)
    auth: {
        user: report.userUID, // Your email address
        pass: 'your-email-password', // Your email password or an app-specific password
    },
});

// Function to send email when a report is resolved
exports.sendEmailNotification = functions.database
    .ref('Make Report Instance/{reportId}/status')
    .onUpdate((change, context) => {
        const beforeStatus = change.before.val();
        const afterStatus = change.after.val();

        // Check if the status changed to 'Resolved'
        if (beforeStatus !== 'Resolved' && afterStatus === 'Resolved') {
            const reportId = context.params.reportId;
            const reportRef = admin.database().ref(`Make Report Instance/${reportId}`);

            // Fetch the report details from the database
            return reportRef.once('value').then(snapshot => {
                const report = snapshot.val();

                // Ensure the report has a userEmail field and reference number
                if (report.userEmail && report.refNumber) {
                    const mailOptions = {
                        from: 'your-email@gmail.com',
                        to: report.userUID, // The user's email from the report data
                        subject: 'Incident Resolved - Civic Alert',
                        text: `Dear User,

Your incident with reference number ${report.refNumber} has been resolved.

Thank you for using Civic Alert.

Best regards,
The Civic Alert Team`,
                    };

                    // Send the email
                    return transporter.sendMail(mailOptions)
                        .then(() => {
                            console.log('Email sent successfully to:', report.userUID);
                        })
                        .catch(error => {
                            console.error('Error sending email:', error);
                        });
                } else {
                    console.error('Report missing email or reference number');
                    return null;
                }
            });
        }

        return null;
    });

    
        function fetchSubmittedReports() {
            const reportsRef = ref(database, 'Make Report Instance');
            
            console.log('Attempting to fetch reports...');  // Debug log
            
            get(reportsRef).then(snapshot => {
                if (snapshot.exists()) {
                    console.log('Data retrieved successfully:', snapshot.val());  // Debug log
                    
                    const reports = snapshot.val();
                    const reportTableBody = document.getElementById('reportTableBody');
                    reportTableBody.innerHTML = '';  // Clear previous data
    
                    Object.keys(reports).forEach(reportId => {
                        const report = reports[reportId];

                        if(report.status === "Resolved"){
                        const row = document.createElement('tr');
    
                        row.innerHTML = `
                            <td>${report.userUID}</td>
                            <td>${report.incidentType}</td>
                            <td>${report.dateTime}</td>
                            <td>${report.refNumber}</td>
                            <td>${report.location}</td>
                            <td>${report.description}</td>
                            <td>${report.status}</td>
                            <td><button class="btn btn-primary" data-report-id="${report.refNumber}">View Image</button></td>
                        `;
    
                        reportTableBody.appendChild(row);
                        }
                    });
    
                    document.querySelectorAll('button[data-report-id]').forEach(button => {
                        button.addEventListener('click', function() {
                            const reportId = this.getAttribute('data-report-id');
                            const report = reports[refNumber]
                           const imageRef = storageRef(storage, `report-images/${report.refNumber}.jpeg`);
    
                            getDownloadURL(imageRef).then(url => {

                        // Display the image and details in the modal
                                    document.getElementById('modalReportImage').src = url;
                                   document.getElementById('modalReportDetails').innerHTML = `
                                    <p><strong>Reference Number:</strong> ${report.refNumber}</p>
                                    <p><strong>User ID:</strong> ${report.userId}</p>
                                   <p><strong>Description:</strong> ${report.description}</p>
                                `;
                                $('#reportModal').modal('show');
                            }).catch(error => {
                                console.error("Error fetching image:", error);  // Debug log
                                alert("Image could not be retrieved.");
                            });
                        });
                    });
                } else {
                    console.error("No data found in the database.");  // Debug log
                    alert("No data available for the reports.");
                }
            }).catch(error => {
                console.error("Error fetching reports:", error);  // Debug log
                alert("Error fetching reports. Please try again.");
            });
        }
    
        fetchSubmittedReports();
    </script>
    
</body>
</html>